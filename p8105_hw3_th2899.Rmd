---
title: "Homework 3"
author: "Tim Hauser"
output: github_document
---

## Initial setup

```{r}
library(tidyverse)
library(ggridges)
library(patchwork)

library(p8105.datasets)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

Loading the instacart dataset:

```{r}
data("instacart")

instacart = 
  instacart %>% 
  as_tibble(instacart)
```

In the following I will do an exploration of the  dataset. First, to gain an overview:

```{r}
skimr::skim(instacart)
```

The Instacart Online Grocery Shopping Dataset is an anonymized dataset with over 3 million online grocery orders from more than 200,000 Instacart users from 2017. It consists of `r nrow(instacart)` observations of products orders, and `r ncol(instacart)` different variables: `r names(instacart)`. In total, there are `r instacart %>% select(product_id) %>% distinct %>% count` products found in `r instacart %>% select(user_id, order_id) %>% distinct %>% count` orders from `r instacart %>% select(user_id) %>% distinct %>% count` distinct users.

Most important variables are:

* `r names(instacart)[1]`: order identifier
* `r names(instacart)[2]`: product identifier
* `r names(instacart)[5]`: customer identifier
* `r names(instacart)[7]`: order sequence number for this user (1=first, n=nth), rages from `r range(pull(instacart, order_number))`
* `r names(instacart)[8]`: day of the week on which the order was placed
* `r names(instacart)[10]`: stands for days since the last order, capped at 30, NA if order_number = 1, ranges from `r range(pull(instacart, days_since_prior_order))`
*`r names(instacart)[10]`: aisle identifier, tells us the location of the item in the warehouse


The following table counts the number of times each aisle is used in the list of orders and orders them by most frequent to least frequent:

```{r}
instacart %>% 
  count(aisle) %>% 
  arrange(desc(n))
```

In total, there are `r instacart %>% select(aisle) %>% distinct %>% count` aisles and the most frequently used are fresh vegetables and fresh fruits.


The following is a plot showing the number of items ordered in each aisle, limited to aisles with more than 10000 items ordered and ordered in ascending order:

```{r}
instacart %>% 
  count(aisle) %>% 
  filter(n > 10000) %>% 
  mutate(aisle = fct_reorder(aisle, n)) %>% 
  ggplot(aes(x = aisle, y = n)) + 
  geom_point() + 
  labs(title = "Number of items ordered in each aisle") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

The next table shows the three most popular items in each of the aisles “baking ingredients”, “dog food care”, and “packaged vegetables fruits” and includes number of times each item is ordered in your table:

```{r}
instacart %>% 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) %>%
  group_by(aisle) %>% 
  count(product_name) %>% 
  mutate(rank = min_rank(desc(n))) %>% 
  filter(rank < 4) %>% 
  arrange(desc(n)) %>%
  knitr::kable()
```

The next table displays the mean hour of the day at which "Pink Lady Apples" and "Coffee Ice Cream" are ordered on each day of the week; formatted in an agenda format (i.e., untidied):

```{r}
instacart %>%
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>%
  group_by(product_name, order_dow) %>%
  summarize(mean_hour = mean(order_hour_of_day)) %>%
  spread(key = order_dow, value = mean_hour) %>%
  knitr::kable(digits = 2)
```


## Problem 2

Load and tidy the dataset (i.e., includes all originally observed variables and values; has useful variable names; includes a weekday vs weekend variable; encodes with reasonable variable classes, reordered variables):
```{r}
accel_df = read.csv("./data/accel_data.csv") %>% 
  janitor::clean_names() %>% 
  pivot_longer(
    activity_1:activity_1440,
    names_to = "minute",
    values_to = "activity_count",
    names_prefix = "activity_"
  ) %>% 
  rename(day_type_1 = day) %>% 
  mutate(
    day_type_2 = if_else((day_type_1 == "Saturday" | day_type_1 == "Sunday"),"Weekend","Weekday"),
    minute = as.numeric(minute),
    week = as.numeric(week),
    day_id = as.numeric(day_id),
    day_type_1 = factor(day_type_1, level = c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")),
    day_type_2 = factor(day_type_2, level = c("Weekday", "Weekend"))
  ) %>% 
  relocate(week, day_id, day_type_1, day_type_2, minute, activity_count)
```

The following helps to generate an overview of the tidied dataset:

```{r}
skimr::skim(accel_df)
```

The dataset contains five weeks of accelerometer data collected on a 63 year-old male with BMI 25, who was admitted to the Advanced Cardiac Care Center of Columbia University Medical Center and diagnosed with congestive heart failure (CHF). Concretely, it consitst of `r nrow(accel_df)` observations of activity counts (one for each minute of each day of a 5 week period), and `r ncol(accel_df)` different variables: `r names(accel_df)` 

* `r names(accel_df)[1]`: week identifier, from `r range(pull(accel_df, week))`, numerical variable
* `r names(accel_df)[2]`: day identifier, from `r range(pull(accel_df, day_id))`, numerical variable
* `r names(accel_df)[3]`: day type 1 from Monday, Sunday, categorical variable
* `r names(accel_df)[4]`: day type 2, Weekday vs. Weekend, categorical variable
* `r names(accel_df)[5]`: minute identifier, from `r range(pull(accel_df, minute))`, numerical variable
* `r names(accel_df)[6]`: activity count (for each minute)

Creating a table with total activity over each day (aggregated across minute):

```{r}
accel_df %>% 
  group_by(day_id) %>% 
  summarize(total_activity = sum(activity_count)) %>% 
  knitr::kable()
```

Plotting above data for better visibility:

```{r}
instacart %>% 
  count(aisle) %>% 
  filter(n > 10000) %>% 
  mutate(aisle = fct_reorder(aisle, n)) %>% 
  ggplot(aes(x = aisle, y = n)) + 
  geom_point() + 
  labs(title = "Number of items ordered in each aisle") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```




* Accelerometer data allows the inspection activity over the course of the day. Make a single-panel plot that shows the 24-hour activity time courses for each day and use color to indicate day of the week. Describe in words any patterns or conclusions you can make based on this graph

